# Pokemon Showdown Rust Port - Development Guide

This document contains important information for working on this project with Claude Code.

## Docker Environment

**IMPORTANT:** All bash commands (cargo, rustc, etc.) must be run inside the Docker container.

The Docker container is named `pokemon-rust-dev` and the workspace is at `/home/builder/workspace`.

### Running Commands in Docker

Always use this pattern for running commands:

```bash
docker exec pokemon-rust-dev bash -c "cd /home/builder/workspace && <command> 2>&1" | tail -20
```

### Examples

**Build the project:**
```bash
docker exec pokemon-rust-dev bash -c "cd /home/builder/workspace && cargo build 2>&1" | tail -40
```

**Run tests:**
```bash
docker exec pokemon-rust-dev bash -c "cd /home/builder/workspace && cargo test 2>&1" | tail -20
```

**Check compilation:**
```bash
docker exec pokemon-rust-dev bash -c "cd /home/builder/workspace && cargo check 2>&1" | tail -20
```

**Run clippy:**
```bash
docker exec pokemon-rust-dev bash -c "cd /home/builder/workspace && cargo clippy 2>&1" | tail -20
```

## Git Operations via HTTP Server

Due to macOS network restrictions that block SSH connections from sandboxed processes, git operations must be performed via an HTTP server proxy.

### Starting the Git Server

The user must start the git server in their shell:

```bash
cd /Users/vjeux/random/showdown/pokemon-showdown-rs
node git-server.js
```

The server runs on `http://127.0.0.1:3456` and accepts git commands via HTTP POST requests.

### Using Git from Claude Code

Once the server is running, use curl to execute git commands:

**Check git status:**
```bash
curl -X POST http://127.0.0.1:3456/git \
  -H "Content-Type: application/json" \
  -d '{"command":"git status"}'
```

**Push commits:**
```bash
curl -X POST http://127.0.0.1:3456/git \
  -H "Content-Type: application/json" \
  -d '{"command":"git push origin master"}'
```

**Pull changes:**
```bash
curl -X POST http://127.0.0.1:3456/git \
  -H "Content-Type: application/json" \
  -d '{"command":"git pull --rebase"}'
```

**Add files:**
```bash
curl -X POST http://127.0.0.1:3456/git \
  -H "Content-Type: application/json" \
  -d '{"command":"git add ."}'
```

**Commit:**
```bash
curl -X POST http://127.0.0.1:3456/git \
  -H "Content-Type: application/json" \
  -d '{"command":"git commit -m \"Your commit message\""}'
```

**Test server is running:**
```bash
curl -X GET http://127.0.0.1:3456/ping
```

### Git Server Response Format

The server returns JSON with:
- `stdout`: Standard output from the git command
- `stderr`: Standard error from the git command
- `exitCode`: Exit code (0 = success)

Example response:
```json
{"stdout":"On branch master\nYour branch is up to date with 'origin/master'.\n","stderr":"","exitCode":0}
```

## Project Structure

- `src/data/move_callbacks/` - Move callback implementations (421 files)
- `src/data/item_callbacks/` - Item callback implementations (326 files)
- `scripts/generate-moves.js` - Generates move callback stubs from TypeScript
- `scripts/generate-items.js` - Generates item callback stubs from TypeScript
- `MOVES_TODO.md` - Tracking file for move implementations
- `ITEMS_TODO.md` - Tracking file for item implementations

## Development Workflow

### Porting Callbacks from JavaScript to Rust

1. Find the callback with `// TODO: Implement 1-to-1 from JS` comment
2. Read the JavaScript implementation from the comment block
3. Implement the Rust version following these rules:
   - **Must be exactly 1-to-1 with JavaScript**
   - Use two-phase borrow pattern (immutable read, then mutable if needed)
   - Return appropriate EventResult variant
   - If infrastructure is missing, document in TODO.md and return `EventResult::Continue`

4. Compile after each implementation:
```bash
docker exec pokemon-rust-dev bash -c "cd /home/builder/workspace && cargo build 2>&1" | tail -40
```

5. Commit if successful:
```bash
git add <files>
git commit -m "Implement <callback_name> for <move/item>"
curl -X POST http://127.0.0.1:3456/git -H "Content-Type: application/json" -d '{"command":"git push origin master"}'
```

### Common Patterns

**Two-phase borrow pattern:**
```rust
// Phase 1: Extract data immutably
let (some_data, other_data) = {
    let pokemon = match battle.pokemon_at(pokemon_pos.0, pokemon_pos.1) {
        Some(p) => p,
        None => return EventResult::Continue,
    };
    (pokemon.some_field, pokemon.other_field)
};

// Phase 2: Use mutable reference
let pokemon_mut = match battle.pokemon_at_mut(pokemon_pos.0, pokemon_pos.1) {
    Some(p) => p,
    None => return EventResult::Continue,
};
pokemon_mut.modify_something();
```

**EventResult variants:**
- `EventResult::Continue` - Continue execution
- `EventResult::Stop` - Stop execution
- `EventResult::NotFail` - Don't fail
- `EventResult::Boolean(bool)` - Return boolean
- `EventResult::Number(i32)` - Return number
- `EventResult::Null` - Return null (prevents default behavior)

**Type multipliers:**
Use `chain_modify_fraction(numerator, denominator)` for damage/stat modifiers:
- 1.2x boost: `chain_modify_fraction(4915, 4096)`
- 1.3x boost: `chain_modify_fraction(5325, 4096)`
- 0.5x reduction: `chain_modify_fraction(2048, 4096)`

## Important Notes

- Never run `cargo` or other build commands directly - always use docker
- Never run `git push` directly - always use the HTTP server
- Check if the git server is running before attempting git operations
- All file paths should be absolute when possible
- Commit frequently with descriptive messages
- Document missing infrastructure in TODO.md files rather than inventing solutions
